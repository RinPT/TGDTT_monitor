name: Website Monitor (Telegram)

on:
  schedule:
    # Cháº¡y má»—i 5 phÃºt (khuyáº¿n nghá»‹). CÃ³ thá»ƒ Ä‘á»•i thÃ nh "*/1 * * * *" nhÆ°ng
    # GitHub khÃ´ng Ä‘áº£m báº£o chÃ­nh xÃ¡c tá»«ng phÃºt.
    - cron: "*/5 * * * *"
  workflow_dispatch: {}  # cho phÃ©p cháº¡y tay

jobs:
  check:
    runs-on: ubuntu-latest

    env:
      URL: "https://thegioidentrangtri.com/"
      RETRIES: "3"          # sá»‘ láº§n thá»­
      RETRY_DELAY: "10"     # giÃ¢y giá»¯a cÃ¡c láº§n thá»­
      TIMEOUT: "10"         # giÃ¢y timeout má»—i láº§n
      EXPECT_CODE_MIN: "200"
      EXPECT_CODE_MAX: "399"

    steps:
      - name: Kiá»ƒm tra website & gá»­i cáº£nh bÃ¡o náº¿u DOWN
        shell: bash
        run: |
          set -euo pipefail

          URL="${URL}"
          RETRIES="${RETRIES}"
          RETRY_DELAY="${RETRY_DELAY}"
          TIMEOUT="${TIMEOUT}"
          MIN="${EXPECT_CODE_MIN}"
          MAX="${EXPECT_CODE_MAX}"

          echo "Checking: $URL"
          fails=0
          codes=()

          for i in $(seq 1 "$RETRIES"); do
            start_ts=$(date +%s%3N || true)
            # dÃ¹ng curl HEAD trÆ°á»›c, náº¿u bá»‹ block thÃ¬ GET nháº¹
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time "$TIMEOUT" -I "$URL" || echo "000")
            if [ "$code" = "000" ] || [ "$code" -lt "$MIN" ] || [ "$code" -gt "$MAX" ]; then
              # thá»­ GET náº¿u HEAD tháº¥t báº¡i/khÃ¡c mong Ä‘á»£i
              code=$(curl -s -o /dev/null -w "%{http_code}" --max-time "$TIMEOUT" "$URL" || echo "000")
            fi
            end_ts=$(date +%s%3N || true)
            rt=$((end_ts - start_ts))
            codes+=("$code")

            if [ "$code" = "000" ] || [ "$code" -lt "$MIN" ] || [ "$code" -gt "$MAX" ]; then
              echo "Attempt $i/$RETRIES: FAIL (HTTP $code, ${rt}ms)"
              fails=$((fails+1))
            else
              echo "Attempt $i/$RETRIES: OK   (HTTP $code, ${rt}ms)"
            fi

            if [ "$i" -lt "$RETRIES" ]; then
              sleep "$RETRY_DELAY"
            fi
          done

          # HÃ m gá»­i Telegram
          send_tg () {
            local text="$1"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              --data-urlencode "text=${text}" >/dev/null
          }

          if [ "$fails" -eq "$RETRIES" ]; then
            # Táº¤T Cáº¢ Ä‘á»u fail â†’ coi nhÆ° DOWN
            now="$(date '+%Y-%m-%d %H:%M:%S %Z')"
            joined="$(IFS=, ; echo "${codes[*]}")"
            msg="ðŸ”´ DOWN: ${URL}%0AHTTP codes: ${joined}%0ATime: ${now}%0AHost: ${GITHUB_REPOSITORY} / ${GITHUB_WORKFLOW}"
            echo "==> DOWN. Sending Telegram..."
            send_tg "$msg"
            exit 1
          else
            echo "==> UP (at least one attempt succeeded)."
          fi
